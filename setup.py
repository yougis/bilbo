# -*- coding: utf-8 -*-
from setuptools import setup

packages = \
['oeilnc_config', 'oeilnc_geoindicator', 'oeilnc_utils']

package_data = \
{'': ['*']}

install_requires = \
['dask-geopandas>=0.3.1,<0.4.0',
 'dask==2024.2.1',
 'earthengine-api',
 'geemap',
 'geoalchemy2>=0.14.4,<0.15.0',
 'geopandas',
 'h3>=3.7.7,<4.0.0',
 'intake-geopandas>=0.4.0,<0.5.0',
 'intake-sql>=0.4.0,<0.5.0',
 'intake>=2.0.1,<3.0.0',
 'lz4>=4.3.3,<5.0.0',
 'msgpack>=1.0.8,<2.0.0',
 'numpy==1.26.4',
 'plotly',
 'psycopg2>=2.9.9,<3.0.0',
 'python-dotenv>=1.0.1,<2.0.0',
 'rasterstats',
 'sqlalchemy>=2.0.27,<3.0.0',
 'tobler>=0.11.2,<0.12.0']

setup_kwargs = {
    'name': 'bilbo-packages',
    'version': '0.1.12',
    'description': 'Package permettant de générer des indicateurs à partir de différentes sources de données (Google Earth Engine, ...).',
    'long_description': '# Bilbo Packages\n\n## Objectifs\n\nCe package a pour ambition de regrouper l\'ensemble des fonctions utiles au traitement de la donnée au sein de l\'Oeil.\nIl se découpe selon plusieurs packages préfixé `oeilnc_` pour les retrouver ensemble si on liste les package d\'un environnement:\n- **oeilnc_config**\n  Ce package contient la configuration globale de l\'application, incluant le chargement des variables d\'environnement et des paramètres de configuration nécessaires au bon fonctionnement de l\'ensemble des composants.\n  - `__init__.py`: Fichier nécessaire pour faire du dossier un package Python.\n  - `settings.py`: Contient les configurations et les variables d\'environnement utilisées par l\'application.\n\n- **oeilnc_geoindicator**\n  Ce package est dédié à la création, au calcul, et à la manipulation des indicateurs géospatiaux. Il englobe tout ce qui est nécessaire pour traiter des données géographiques et générer des indicateurs.\n  - `__init__.py`: Fichier nécessaire pour faire du dossier un package Python.\n  - `calculation.py`: Fournit des fonctions pour calculer des indicateurs basés sur des données géospatiales.\n  - `distribution.py`: Contient des méthodes pour distribuer le calcul des indicateurs sur différents nœuds ou processus.\n  - `gee_credentials.json`: Contient les credentials pour accéder à Google Earth Engine.\n  - `gee.py`: Intègre les fonctionnalités de Google Earth Engine pour le traitement d\'images satellites et la génération d\'indicateurs.\n  - `geometry.py`: Offre des fonctions pour la manipulation et le traitement de données géométriques.\n  - `interpolation.py`: Fournit des méthodes pour interpoler les valeurs entre les points de données spatiales.\n  - `raster.py`: Contient des fonctions pour manipuler des données raster, y compris la lecture, l\'écriture et le traitement de ces données.\n\n- **oeilnc_utils**\n  Regroupe un ensemble de fonctions utilitaires qui peuvent être utilisées à travers le projet pour des tâches communes comme la connexion à des bases de données, la manipulation de dataframes, etc.\n  - `__init__.py`: Fichier nécessaire pour faire du dossier un package Python.\n  - `connection.py`: Gère les connexions aux bases de données.\n  - `dataframe.py`: Offre des fonctions pour manipuler des dataframes, notamment pour leur nettoyage, leur transformation, et leur agrégation.\n  - `geometry.py`: Propose des outils pour la manipulation de données géométriques, souvent complémentaires à ceux dans `oeilnc_geoindicator`.\n  - `raster.py`: Fournit des outils pour la manipulation de données raster, pouvant inclure des fonctionnalités telles que le re-échantillonnage ou le calcul de statistiques sur des images raster.\n\nLes scripts spécifiques à chaque projet seront par conséquent de taille très réduite car l\'ensemble des traitements utilisera ces packages.\n\nVariables d\'environnement utilisées dans certaines méthodes\n\n```bash\n\n\'SCHEDULER_IP\' = "172.20.12.13:9787"\n\'COMMUN_PATH\' = "/media/commun/commun/"\n\'ARCHIVE_PATH\' = "media/archive/"\n\'PATH_INFOCENTRE_APP\' = ${COMMUN_PATH}Informatique/SIG/Application/Jupyterhub/\n\'PROJECT_PATH\' = ${PATH_INFOCENTRE_APP}projets/${PROJECT_ID}/\n\'DATA_CATALOG_DIR\' = ${PATH_INFOCENTRE_APP}projets/catalogFiles/ \n\'DATA_CONFIG_DIR\' = ${DATA_CATALOG_DIR}data_config_files/\n\'DATA_OUTPUT_DIR\' = ${PROJECT_PATH}output/\n\'SIG_DATA_PATH\' = ${COMMUN_PATH}Informatique/SIG/Donnees/\n\'STAC_CATALOG_PATH\' =  ${ARCHIVE_PATH}STAC/\n\'DIM_CATALOG_DIR\' = ${PATH_INFOCENTRE_APP}projets/catalogFiles/\n\n```\n\n\n## Déployer\n\nconsidérant que le nom de l\'environnement conda est **gis311** : \n\n```\nconda run --name gis311 pip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages"\n```\n\nle déploiement se fait en mode *--quiet*\npour voir ce qui se passe activer d\'abord l\'environnement conda \n`conda activate gis311`\n\net lancer pip directement :\n\n`pip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages"`\n\n\n### Déployer sans installer les dépendances\n\nDe nombreuses dépendances sont indiquées dans le fichier .toml \nCela peut être utile de ne pas vouloir réinstaller toutes les dépendances à chaque déploiement. Pour cela il faut ajouter `--no-deps`\n\n`conda run --name gis311_base pip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages" --no-deps`\n\n\n### Déployer un sous package uniquement\nPour déployer uniquement un sous packages  il faut ajouter indiquer # et remplacer [nom_du_sous_package]\n\n```\npip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages@refactoring_from_bilbo#[nom_du_sous_package]"\n```\n\n**Quelques exemples** \n```\npip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages@refactoring_from_bilbo#oeilnc_geoindicator"\n```\n\n`pip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages@refactoring_from_bilbo#oeilnc_utils"`\n\n`pip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages@refactoring_from_bilbo#oeilnc_config"`\n\n\n#### troubleshooting\n\nSur windows la commande git n\'aboutit jamais car une popup credential manager n\'est pas renvoyé si la commande est faite depuis un protocole SSH. il faut lancer la commande git sur le poste et activer l\'option de ne plus demander l\'autorisation. \n\nparfois, bien que SSH soit installé sur windows, il faut redemarer le protocole pour pouvoir se connecter au machine\n`Restart-Service sshd`\n\n###\xa0Déployer sur le **Scheduler**\nLe scheduler utilise un environnement conda "light" suffixé de  *_base*.\n\n```\nconda run --name gis311_base pip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages"\n```\n\n## Déployer à partir d\'une branche du repot git sur le scheduler\nPour déployer les packages à partir d\'une branche, il faut ajouter @ et remplacer [nom_de_la_branche]\n\n`conda run --name gis311 pip install --force-reinstall --upgrade --exists-action=w  "git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages@[nom_de_la_branche]"`\n\n## Développer et contribuer\n\nPour développer des packages Python avec Visual Studio Code (VSCode) à partir d\'une source Git clonée localement et gérer les dépendances avec **Poetry**.\nVous pourez ensuite lancer les tests unitaires de manière à ce que l\'interpréteur Python trouve les fichiers sources locaux.\n\n### Installer et configurer Poetry\n\nPour contribuer au package vous pouvez utiliser l\'environnement virtuel créé par poetry.\nPour installer poetry, il suffit de faire :\n```shell\n# installer \ncurl -sSL https://install.python-poetry.org | python3 -\n\n```\n\nUne fois installé, ouvrez un terminal dans VSCode (Terminal > Nouveau terminal) et naviguez vers le dossier de votre projet si ce n\'est pas déjà fait. Ensuite, configurez Poetry pour le projet :\n\n\nexemple de sortie \n```\nhugo@RSIdebian:~/projets/bilbo-packages$ poetry shell\nSpawning shell within /home/hugo/.cache/pypoetry/virtualenvs/bilbo-packages-fNViwJlA-py3.9\n. /home/hugo/.cache/pypoetry/virtualenvs/bilbo-packages-fNViwJlA-py3.9/bin/activate\n(base) hugo@RSIdebian:~/projets/bilbo-packages$ . /home/hugo/.cache/pypoetry/virtualenvs/bilbo-packages-fNViwJlA-py3.9/bin/activate\n(bilbo-packages-py3.9) (base) hugo@RSIdebian:~/projets/bilbo-packages$ poetry install\nInstalling dependencies from lock file\n\nNo dependencies to install or update\n\nInstalling the current project: bilbo-packages (0.0.4)\n```\n\n``` \npoetry shell\n```\n\nex. de retour : \n\nhugo@RSIdebian:~/projets/bilbo-packages$ \n\n``` \npoetry install\n```\n\n### Configurer l\'interpréteur Python dans VSCode\n\nAssurez-vous que l\'extension Python est installée dans VSCode. Ensuite, configurez VSCode pour utiliser l\'interpréteur Python créé par Poetry :\n\nOuvrez la palette de commandes `Ctrl+Shift+P`.\nTapez "Python: Select Interpreter" et sélectionnez-le.\nChoisissez l\'interpréteur qui correspond à l\'environnement virtuel de votre projet Poetry. Il devrait être nommé quelque chose comme Python 3.x (\'nom_du_projet-py3.x\': poetry).\n\n**Vous ne trouvez pas l\'interpreteur**\n\nUtilisez la commande `poetry env list`\n\nSi vous voyez que l\'environnement virtuel créé par Poetry est listé et activé (comme indiqué par "Activated") mais que vous ne le voyez pas dans VSCode lorsque vous essayez de sélectionner l\'interpréteur Python, voici quelques étapes supplémentaires à considérer pour résoudre ce problème :\n\nAjoutez le chemin vers le dossier contenant les environnements virtuels de Poetry. Vous pouvez trouver ce chemin en exécutant `poetry env info -p`\n\n#### Commande Poetry utiles\n\n**Ajouter une dépendance supplémentaire au projet**\n```\npoetry add ${package-name}\n```\n\n**Ajouter une dépendance supplémentaire au projet**\n\n```\npoetry update\n```\n\n**Ajouter toutes les dépendance dans le fichier lock**\n\n```\npoetry lock\n```\n\n**Exécuter les tests**\n\nnécéssite le package pytest. \n```\npoetry run pytest\n```\n\n### Changer la version de Python utilisée par Poetry \nPour changer la version de Python utilisée par Poetry, vous pouvez suivre ces étapes :\n\n1. **Vérifier les versions de Python disponibles :**\n   Tout d\'abord, vérifiez les versions de Python disponibles sur votre système en utilisant la commande :\n   ```\n   poetry env list\n   ```\n\n2. **Ajouter une nouvelle version de Python :**\n   Si la version de Python que vous souhaitez utiliser n\'est pas déjà installée, vous pouvez l\'ajouter avec Poetry. Par exemple, pour ajouter Python 3.9, utilisez la commande :\n   ```\n   poetry env use 3.11\n   ```\n\n3. **Changer la version de Python :**\n   Si la version que vous souhaitez utiliser est déjà installée, vous pouvez simplement basculer vers cette version en utilisant la commande :\n   ```\n   poetry env use <version>\n   ```\n   Remplacez `<version>` par la version de Python que vous souhaitez utiliser, par exemple `3.11`.\n\n4. **Mettre à jour le fichier de verrouillage des dépendances :**\n   Après avoir changé la version de Python, vous devriez mettre à jour le fichier `pyproject.toml` pour refléter la nouvelle version de Python. Cela garantira que les autres utilisateurs de votre projet ou votre système de construction utilisent la même version de Python. Assurez-vous de spécifier la nouvelle version dans la section `[tool.poetry]` du fichier `pyproject.toml`.\n\n5. **Reconstruire l\'environnement :**\n   Une fois que vous avez modifié la version de Python dans votre projet Poetry, reconstruisez l\'environnement virtuel avec la nouvelle version en utilisant la commande :\n   ```\n   poetry install\n   ```\n\nSi malgrès ces étapes, python n\'est pas à la version la plus récente (il peut y avoir un décalage entre les repo utilisés par poetry et conda), il faut faire ceci :\n```\npoetry shell\n```\n\npour python 3.11.8\n```\nconda install python=3.11.8\n```\n\n\n## Developper et évaluer sur l\'infrastructure clusterisée\n\nLorsqu\'on développe un nouvelle version du package vous pourriez rencontrer des erreurs sans quelles soient veritablement explicite :\nex : \n\n| RuntimeError: Error during deserialization of the task graph. This frequently\n|\xa0occurs if the Scheduler and Client have different environments.\n| For more information, see\n|\xa0https://docs.dask.org/en/stable/deployment-considerations.html#consistent-software-environments\n\nAssurez vous d\'avoir des environnements identiques entre les workers , le scheduler et le client.\ncela signifie que lorsque vous souhaitez tester un nouveau module sur le cluster, il faut penser à déployer les librairies de la branche en cours de développement. Pour cela le script deploy.sh va nous aider à faire ce travail dans les différents environnement (qualif et production):\n\npour rappel, la documentation se trouve  [ici dans le projet backup](https://dev.azure.com/Oeilnc/Backup)\n\n\nex. \n- installer la dernière version de generate_indicator sur l\'environnement de qualification sur les machines du cluster: \n```\n./deploy.sh conda --hosts 172.20.12.14,172.20.12.15,172.20.12.16,172.20.12.17 --packages git+https://informatique:rxf4qdzjc5pccj2423ycuedtyma3ughg6e2oepohoc7oilbbjukq@dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages@[branche-name]\n\n```\n\n### Configugrer le debugeur python VSCODE \n\nPour débuger le traitement fait par un worker, configurer un executeur debug dans le launch.json:\n\n```\n{\n    "version": "0.2.0",\n    "configurations": [\n        {\n            "name": "Debug Dask Worker PROD",\n            "type": "debugpy",\n            "request": "launch",\n            "module": "dask.distributed.cli.dask_worker",\n            "args": [\n                "172.20.12.13:9786", // Adresse du scheduler\n                "--nthreads=1",\n                "--preload",\n                "{path-to-dev-package}/bilbo-packages/oeilnc_config/preload_worker.py"\n            ],\n            "console": "integratedTerminal"\n        },\n        {\n            "name": "Debug Dask Worker QUALIF",\n            "type": "debugpy",\n            "request": "launch",\n            "module": "dask.distributed.cli.dask_worker",\n            "args": [\n                "172.20.12.11:8786", // Adresse du scheduler\n                "--nthreads=1",\n                "--preload",\n                "{path-to-dev-package}/bilbo-packages/oeilnc_config/preload_worker.py"\n            ],\n            "console": "integratedTerminal"\n        }\n\n\n    ]\n}\n\n       \n\n```',
    'author': 'Clément Niot',
    'author_email': 'clement.niot@oeil.nc',
    'maintainer': 'None',
    'maintainer_email': 'None',
    'url': 'https://dev.azure.com/Oeilnc/Bilbo/_git/bilbo-packages',
    'packages': packages,
    'package_data': package_data,
    'install_requires': install_requires,
    'python_requires': '>=3.11.8,<4.0.0',
}


setup(**setup_kwargs)

